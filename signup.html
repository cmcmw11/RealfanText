<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBJ14OYFCG4FAtcLBp_jqWRbZhmaFIVlkg",
  authDomain: "realfantext-89dc3.firebaseapp.com",
  projectId: "realfantext-89dc3",
  storageBucket: "realfantext-89dc3.appspot.com",
  messagingSenderId: "356157848865",
  appId: "1:356157848865:web:cc62438b1e20ef8e801260",
  measurementId: "G-8K4NBE3B61"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let selectedAvatar = "";
let profileFile = null;

// ‡πÅ‡∏™‡∏î‡∏á preview ‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á
document.getElementById('profileUpload').addEventListener('change', (e)=>{
  profileFile = e.target.files[0];
  if(profileFile){
    const reader = new FileReader();
    reader.onload = ()=> document.getElementById('profilePreview').src = reader.result;
    reader.readAsDataURL(profileFile);
  }
});

// ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏ß‡∏≤‡∏ï‡∏≤‡∏£‡πå
document.querySelectorAll('#avatars img').forEach(img=>{
  img.addEventListener('click',()=>{
    document.querySelectorAll('#avatars img').forEach(i=>i.classList.remove('selected'));
    img.classList.add('selected');
    selectedAvatar = img.src;
  });
});

document.getElementById('signupForm').addEventListener('submit', async (e)=>{
  e.preventDefault();

  const realName = document.getElementById('realName').value.trim();
  const birthday = document.getElementById('birthday').value;
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  const friendQuestion = document.getElementById('friendQuestion').value.trim();
  const avatarName = document.getElementById('avatarName').value.trim();

  if(!selectedAvatar){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏ß‡∏≤‡∏ï‡∏≤‡∏£‡πå üí´"); return; }
  if(!profileFile){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå üí´"); return; }

  try{
    const userCredential = await createUserWithEmailAndPassword(auth,email,password);
    const userId = userCredential.user.uid;

    // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏õ Firebase Storage
    const profileRef = ref(storage, `profiles/${userId}_${profileFile.name}`);
    await uploadBytes(profileRef, profileFile);
    const profileURL = await getDownloadURL(profileRef);

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Firestore
    await setDoc(doc(db,"users",userId),{
      realName,
      birthday,
      email,
      avatar:selectedAvatar,
      avatarName, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏ß‡∏≤‡∏ï‡∏≤‡∏£‡πå
      profile: profileURL,
      friendQuestion,
      createdAt: new Date()
    });

    alert("üå∏ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
    window.location.href="login.html";
  }catch(err){
    alert("‚ùå "+err.message);
  }
});
</script>
