<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå üíú</title>
<link href="https://fonts.googleapis.com/css2?family=Mali:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{--blue:#a5c9ff;--purple:#d6b8ff;--white:#ffffff;--bg:#f5f7ff;--text:#333;--shadow:0 4px 10px rgba(0,0,0,0.05);--radius:18px;}
body{font-family:'Mali',sans-serif;margin:0;background:var(--bg);color:var(--text);display:flex;flex-direction:column;align-items:center;max-width:430px;margin:0 auto;}
header{background:linear-gradient(90deg,var(--blue),var(--purple));color:var(--white);width:100%;text-align:center;padding:12px 0;font-size:1.4rem;font-weight:600;border-bottom-left-radius:var(--radius);border-bottom-right-radius:var(--radius);}
main{width:100%;padding:16px 16px 80px 16px;flex:1;}
.profile-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.avatar-large{width:60px;height:60px;border-radius:50%;}
.profile-info{flex:1;margin-left:12px;}
.profile-info h2{margin:0;font-size:1.2rem;}
.profile-info p{margin:2px 0;font-size:0.9rem;color:#555;}
.edit-btn{padding:6px 12px;border:none;border-radius:16px;background:linear-gradient(135deg,var(--purple),var(--blue));color:white;cursor:pointer;}
.post{background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px 16px;margin-bottom:12px;}
.post .author{font-weight:600;color:#6a5acd;margin-bottom:6px;}
.post .content{margin-top:4px;}
.post .repost{font-size:0.85rem;color:#555;margin-top:4px;}
footer{background:var(--white);position:fixed;bottom:0;width:100%;max-width:430px;display:flex;justify-content:space-around;padding:10px 0;box-shadow:0 4px 10px rgba(0,0,0,0.05);border-top-left-radius:var(--radius);border-top-right-radius:var(--radius);}
footer button{background:none;border:none;font-size:1.5rem;cursor:pointer;}

/* Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå */
#editProfileModal{
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.5);
  justify-content:center;
  align-items:center;
}
#editProfileModal form{
  background:white;
  padding:16px;
  border-radius:18px;
  width:90%;
  max-width:400px;
}
#editProfileModal img{
  width:100px;height:100px;border-radius:50%;object-fit:cover;border:2px solid #6a5acd;margin-bottom:8px;
}
#editProfileModal input, #editProfileModal button{
  width:100%;padding:8px;margin:6px 0;border-radius:12px;border:1px solid #ddd;font-family:'Mali';font-size:1rem;
}
#editProfileModal button[type="submit"]{
  background:linear-gradient(135deg,#d6b8ff,#a5c9ff);
  color:white;
  border:none;
  cursor:pointer;
}
#editProfileModal button[type="button"]{
  background:#ccc;
  color:#333;
  border:none;
  cursor:pointer;
}
</style>
</head>
<body>

<header>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå üíú</header>

<main>
  <div class="profile-header">
    <img src="" id="profileAvatar" class="avatar-large">
    <div class="profile-info">
      <h2 id="profileName"></h2>
      <p>‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏ß‡∏≤‡∏ï‡∏≤‡∏£‡πå: <span id="profileAvatarName">-</span></p>
      <p>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô: <span id="friendCount">0</span> ‡∏Ñ‡∏ô</p>
    </div>
    <button class="edit-btn" onclick="editProfile()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
  </div>

  <div id="userPosts"></div>
</main>

<!-- Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå -->
<div id="editProfileModal">
  <form id="editProfileForm">
    <h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h3>
    <div style="text-align:center; margin-bottom:12px;">
      <img id="editAvatarPreview" src="">
      <input type="file" id="editAvatarUpload" accept="image/*">
    </div>
    <input type="text" id="editRealName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á" required>
    <input type="text" id="editAvatarName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏ß‡∏≤‡∏ï‡∏≤‡∏£‡πå">
    <button type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    <button type="button" onclick="closeEditModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
  </form>
</div>

<footer>
  <button onclick="goTo('index.html')">üè†</button>
  <button onclick="goTo('chat.html')">üí¨</button>
  <button onclick="goTo('profile.html')">üßë</button>
  <button onclick="goTo('friendsearch.html')">üßë‚Äçü§ù‚Äçüßë</button>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getFirestore, collection, query, orderBy, getDocs, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-storage.js";

// Firebase Config ‡πÉ‡∏´‡∏°‡πà
const firebaseConfig = {
  apiKey: "AIzaSyBJ14OYFCG4FAtcLBp_jqWRbZhmaFIVlkg",
  authDomain: "realfantext-89dc3.firebaseapp.com",
  databaseURL: "https://realfantext-89dc3-default-rtdb.firebaseio.com",
  projectId: "realfantext-89dc3",
  storageBucket: "realfantext-89dc3.firebasestorage.app",
  messagingSenderId: "356157848865",
  appId: "1:356157848865:web:cc62438b1e20ef8e801260",
  measurementId: "G-8K4NBE3B61"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// session
const currentUserId = localStorage.getItem("currentUserId");
if(!currentUserId){
  alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô");
  window.location.href = "login.html";
}

const profileAvatar = document.getElementById('profileAvatar');
const profileName = document.getElementById('profileName');
const profileAvatarName = document.getElementById('profileAvatarName');
const friendCount = document.getElementById('friendCount');
const userPosts = document.getElementById('userPosts');

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
async function loadProfile(){
  const userDoc = await getDoc(doc(db,"users",currentUserId));
  const data = userDoc.data();
  profileAvatar.src = data.avatar || 'https://via.placeholder.com/60';
  profileName.textContent = data.realName || '-';
  profileAvatarName.textContent = data.avatarName || '-';
  friendCount.textContent = data.friends?.length || 0;
}

// ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
async function loadPosts(){
  const postsRef = collection(db,"posts");
  const q = query(postsRef, orderBy("createdAt","desc"));
  const snapshot = await getDocs(q);
  userPosts.innerHTML='';
  snapshot.forEach(doc=>{
    const data = doc.data();
    if(data.userId !== currentUserId) return;
    const postDiv = document.createElement('div');
    postDiv.className = 'post';
    postDiv.innerHTML = `
      <div class="author">${data.author}</div>
      <div class="content">${data.text || ''}${data.fileURL? `<br><a href="${data.fileURL}" target="_blank">üìé ‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå</a>` : ''}</div>
      ${data.repostFrom?`<div class="repost">üîÅ ‡∏£‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏à‡∏≤‡∏Å ${data.repostFrom}</div>` : ''}
    `;
    userPosts.appendChild(postDiv);
  });
}

// Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
const editModal = document.getElementById('editProfileModal');
const editAvatarPreview = document.getElementById('editAvatarPreview');
let newProfileFile = null;

function editProfile(){
  editModal.style.display='flex';
  editAvatarPreview.src = profileAvatar.src;
  document.getElementById('editRealName').value = profileName.textContent;
  document.getElementById('editAvatarName').value = profileAvatarName.textContent==='-'?'':profileAvatarName.textContent;
}

function closeEditModal(){ editModal.style.display='none'; }

document.getElementById('editAvatarUpload').addEventListener('change',(e)=>{
  newProfileFile = e.target.files[0];
  if(newProfileFile){
    const reader = new FileReader();
    reader.onload = ()=> editAvatarPreview.src = reader.result;
    reader.readAsDataURL(newProfileFile);
  }
});

// submit form ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
document.getElementById('editProfileForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const newName = document.getElementById('editRealName').value.trim();
  const newAvatarName = document.getElementById('editAvatarName').value.trim();
  let newAvatarURL = profileAvatar.src;

  try{
    if(newProfileFile){
      const avatarRef = ref(storage, `profiles/${currentUserId}_${newProfileFile.name}`);
      await uploadBytes(avatarRef, newProfileFile);
      newAvatarURL = await getDownloadURL(avatarRef);
    }

    await updateDoc(doc(db,"users",currentUserId),{
      realName: newName,
      avatar: newAvatarURL,
      avatarName: newAvatarName
    });

    profileAvatar.src = newAvatarURL;
    profileName.textContent = newName;
    profileAvatarName.textContent = newAvatarName || '-';
    alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ üíú");
    closeEditModal();
  }catch(err){
    alert("‚ùå "+err.message);
  }
});

function goTo(page){ window.location.href=page; }

loadProfile();
loadPosts();
</script>

</body>
</html>
