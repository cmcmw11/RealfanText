<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå üíú</title>
<link href="https://fonts.googleapis.com/css2?family=Mali:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{--blue:#a5c9ff;--purple:#d6b8ff;--white:#ffffff;--bg:#f5f7ff;--text:#333;--shadow:0 4px 10px rgba(0,0,0,0.05);--radius:18px;}
body{font-family:'Mali',sans-serif;margin:0;background:var(--bg);color:var(--text);display:flex;flex-direction:column;align-items:center;max-width:430px;margin:0 auto;}
header{background:linear-gradient(90deg,var(--blue),var(--purple));color:var(--white);width:100%;text-align:center;padding:12px 0;font-size:1.4rem;font-weight:600;border-bottom-left-radius:var(--radius);border-bottom-right-radius:var(--radius);}
main{width:100%;padding:16px 16px 80px 16px;flex:1;}
.profile-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.avatar-large{width:60px;height:60px;border-radius:50%;}
.profile-info{flex:1;margin-left:12px;}
.profile-info h2{margin:0;font-size:1.2rem;}
.profile-info p{margin:2px 0;font-size:0.9rem;color:#555;}
.edit-btn{padding:6px 12px;border:none;border-radius:16px;background:linear-gradient(135deg,var(--purple),var(--blue));color:white;cursor:pointer;}
.post{background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px 16px;margin-bottom:12px;}
.post .author{font-weight:600;color:#6a5acd;margin-bottom:6px;}
.post .content{margin-top:4px;}
.post .repost{font-size:0.85rem;color:#555;margin-top:4px;}
footer{background:var(--white);position:fixed;bottom:0;width:100%;max-width:430px;display:flex;justify-content:space-around;padding:10px 0;box-shadow:0 4px 10px rgba(0,0,0,0.05);border-top-left-radius:var(--radius);border-top-right-radius:var(--radius);}
footer button{background:none;border:none;font-size:1.5rem;cursor:pointer;}
</style>
</head>
<body>

<header>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå üíú</header>

<main>
  <div class="profile-header">
    <img src="" id="profileAvatar" class="avatar-large">
    <div class="profile-info">
      <h2 id="profileName"></h2>
      <p>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô: <span id="friendCount">0</span> ‡∏Ñ‡∏ô</p>
    </div>
    <button class="edit-btn" onclick="editProfile()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
  </div>

  <div id="userPosts"></div>
</main>

<footer>
  <button onclick="goTo('index.html')">üè†</button>
  <button onclick="goTo('chat.html')">üí¨</button>
  <button onclick="goTo('profile.html')">üßë</button>
  <button onclick="goTo('friendsearch.html')">üßë‚Äçü§ù‚Äçüßë</button>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getFirestore, collection, query, orderBy, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDxapGSRNjYTlpOJwrxpei2BY5XwqIlg0s",
  authDomain: "realfantext.firebaseapp.com",
  databaseURL: "https://realfantext-default-rtdb.firebaseio.com",
  projectId: "realfantext",
  storageBucket: "realfantext.firebasestorage.app",
  messagingSenderId: "1095067084325",
  appId: "1:1095067084325:web:ca46c22741e60ee99a01cc",
  measurementId: "G-TYRV3WJTJV"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// session
const currentUserId = localStorage.getItem("currentUserId");
const currentAvatar = localStorage.getItem("avatar");
const currentName = localStorage.getItem("realName");

if(!currentUserId){
  alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô");
  window.location.href = "login.html";
}

const profileAvatar = document.getElementById('profileAvatar');
const profileName = document.getElementById('profileName');
const friendCount = document.getElementById('friendCount');
const userPosts = document.getElementById('userPosts');

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
async function loadProfile(){
  const userDoc = await getDoc(doc(db,"users",currentUserId));
  const data = userDoc.data();
  profileAvatar.src = data.avatar || 'https://via.placeholder.com/60';
  profileName.textContent = data.realName || currentName;
  friendCount.textContent = data.friends?.length || 0;
}

// ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
async function loadPosts(){
  const postsRef = collection(db,"posts");
  const q = query(postsRef, orderBy("createdAt","desc"));
  const snapshot = await getDocs(q);
  userPosts.innerHTML='';

  snapshot.forEach(doc=>{
    const data = doc.data();
    if(data.userId !== currentUserId) return; // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á

    const postDiv = document.createElement('div');
    postDiv.className = 'post';
    postDiv.innerHTML = `
      <div class="author">${data.author}</div>
      <div class="content">${data.text || ''}${data.fileURL? `<br><a href="${data.fileURL}" target="_blank">üìé ‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå</a>` : ''}</div>
      ${data.repostFrom?`<div class="repost">üîÅ ‡∏£‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏à‡∏≤‡∏Å ${data.repostFrom}</div>` : ''}
    `;
    userPosts.appendChild(postDiv);
  });
}

// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
function editProfile(){
  const newName = prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà:", profileName.textContent);
  if(newName){
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï Firestore (mock)
    profileName.textContent = newName;
    // TODO: update firestore users doc
    alert("‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ üíú");
  }
}

function goTo(page){ window.location.href=page; }

loadProfile();
loadPosts();
</script>

</body>
</html>
