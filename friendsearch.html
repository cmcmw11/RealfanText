<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô üíú</title>
<link href="https://fonts.googleapis.com/css2?family=Mali:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{--blue:#a5c9ff;--purple:#d6b8ff;--white:#ffffff;--bg:#f5f7ff;--text:#333;--shadow:0 4px 10px rgba(0,0,0,0.05);--radius:18px;}
body{font-family:'Mali',sans-serif;margin:0;background:var(--bg);color:var(--text);display:flex;flex-direction:column;align-items:center;max-width:430px;margin:0 auto;}
header{background:linear-gradient(90deg,var(--blue),var(--purple));color:var(--white);width:100%;text-align:center;padding:12px 0;font-size:1.4rem;font-weight:600;border-bottom-left-radius:var(--radius);border-bottom-right-radius:var(--radius);}
main{width:100%;padding:16px 16px 80px 16px;flex:1;}
.search-box{display:flex;margin-bottom:16px;}
.search-box input{flex:1;padding:8px;border-radius:16px;border:1px solid #ddd;margin-right:4px;}
.search-box button{padding:8px 12px;border:none;border-radius:16px;background:linear-gradient(135deg,var(--purple),var(--blue));color:white;cursor:pointer;}
.user-card{display:flex;align-items:center;background:var(--white);padding:8px 12px;margin-bottom:12px;border-radius:var(--radius);box-shadow:var(--shadow);}
.user-card img{width:50px;height:50px;border-radius:50%;margin-right:12px;}
.user-info{flex:1;}
.user-info h3{margin:0;font-size:1rem;}
.user-info p{margin:2px 0;font-size:0.85rem;color:#555;}
.add-btn{padding:6px 12px;border:none;border-radius:16px;background:linear-gradient(135deg,var(--blue),var(--purple));color:white;cursor:pointer;}
footer{background:var(--white);position:fixed;bottom:0;width:100%;max-width:430px;display:flex;justify-content:space-around;padding:10px 0;box-shadow:0 4px 10px rgba(0,0,0,0.05);border-top-left-radius:var(--radius);border-top-right-radius:var(--radius);}
footer button{background:none;border:none;font-size:1.5rem;cursor:pointer;}
</style>
</head>
<body>

<header>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô üíú</header>

<main>
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô...">
    <button id="searchBtn">üîç</button>
  </div>
  <div id="results"></div>
</main>

<footer>
  <button onclick="goTo('index.html')">üè†</button>
  <button onclick="goTo('chat.html')">üí¨</button>
  <button onclick="goTo('profile.html')">üßë</button>
  <button onclick="goTo('friendsearch.html')">üßë‚Äçü§ù‚Äçüßë</button>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getFirestore, collection, query, orderBy, getDocs, doc, getDoc, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDxapGSRNjYTlpOJwrxpei2BY5XwqIlg0s",
  authDomain: "realfantext.firebaseapp.com",
  databaseURL: "https://realfantext-default-rtdb.firebaseio.com",
  projectId: "realfantext",
  storageBucket: "realfantext.firebasestorage.app",
  messagingSenderId: "1095067084325",
  appId: "1:1095067084325:web:ca46c22741e60ee99a01cc",
  measurementId: "G-TYRV3WJTJV"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// session
const currentUserId = localStorage.getItem("currentUserId");
const currentAvatar = localStorage.getItem("avatar");
const currentName = localStorage.getItem("realName");

if(!currentUserId){
  alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô");
  window.location.href = "login.html";
}

const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const results = document.getElementById('results');

// ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
searchBtn.addEventListener('click', async ()=>{
  const qText = searchInput.value.trim().toLowerCase();
  results.innerHTML='';
  if(!qText) return;

  const usersRef = collection(db,"users");
  const snapshot = await getDocs(usersRef);

  snapshot.forEach(doc=>{
    const data = doc.data();
    if(doc.id===currentUserId) return; // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
    if(data.realName.toLowerCase().includes(qText)){
      const card = document.createElement('div');
      card.className = 'user-card';
      card.innerHTML = `
        <img src="${data.avatar || 'https://via.placeholder.com/50'}">
        <div class="user-info">
          <h3>${data.realName}</h3>
          <p>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: ${data.friendQuestion || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}</p>
        </div>
        <button class="add-btn">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</button>
      `;
      const btn = card.querySelector('.add-btn');
      btn.addEventListener('click', ()=>sendFriendRequest(doc.id, data.friendQuestion));
      results.appendChild(card);
    }
  });
});

// ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
async function sendFriendRequest(targetId, question){
  let answer = prompt(`‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô: ${question || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°'}`);
  if(answer===null) return;
  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ Firestore (mock)
  const targetRef = doc(db,"users",targetId);
  await updateDoc(targetRef,{friendRequests: arrayUnion({from:currentUserId,answer})});
  alert("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ üíú");
}

function goTo(page){ window.location.href=page; }
</script>

</body>
</html>
